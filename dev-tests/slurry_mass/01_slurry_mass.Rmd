---
title: '1. Slurry mass tests using `abm_variable()`'
output: pdf_document
author: Sasha D. Hafner
date: "`r format(Sys.time(), '%d %B, %Y %H:%M')`"
---

# Overview
Point of these tests is to check behavior of `abm()` when slurry mass is variable.
Development of the relevant code has been challenging, so it is important to check behavior of multiple scenarios after an update.

# Prep

```{r}
devtools::load_all()
```

# Case 1, consecutive removals

Slurry mass data.

```{r}
slurry_mass_dat <- data.frame(time = c(0, 1, 10, 15, 30), slurry_mass = c(1000, 7000, 2000, 1500, 3000))
plot(slurry_mass ~ time, data = slurry_mass_dat, type = 'o')
```

```{r}
mng_pars = list(slurry_prod_rate = 5700,
                slurry_mass = slurry_mass_dat,    
                storage_depth = 4,    
                resid_depth = 0.05,     
                area = 1000,             
                empty_int = 42,         
                temp_C = 20,
                wash_water = 0,            
                wash_int = NA,
                rest_d = 0,
                cover = 'none',
                resid_enrich = 1,
                scale = c(ks_coefficient = 1, qhat_opt = 1, xa_fresh = 1, yield = 1, alpha_opt = 1))

```

```{r}
out0 <- abm(30, delta_t = 0.1, mng_pars = mng_pars)
```



Default, with "early" behavior.

```{r}
out1 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat))
```

Late

```{r}
out2 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'late'))
```

And mid

```{r}
out3 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'mid'))
```

```{r}
plot(out1$time, out1$slurry_mass, type = 'l')
lines(out2$time, out2$slurry_mass, type = 'l', col = 'blue')
lines(out3$time, out3$slurry_mass, type = 'l', col = 'orange')
points(slurry_mass_dat$time, slurry_mass_dat$slurry_mass, col = 'red', pch = 19)
```

Expect that all three approaches hit the red points (input level) exactly.

Methane production rate:

```{r}
plot(out1$time, out1$CH4_emis_rate, type = 'l', ylim = c(0, 1000))
lines(out2$time, out2$CH4_emis_rate, type = 'l', col = 'blue')
lines(out3$time, out3$CH4_emis_rate, type = 'l', col = 'orange')
```

# Case 2, slurry removal at the beginning

```{r}
slurry_mass_dat <- data.frame(time = c(0, 1, 10, 15, 30), 
                              slurry_mass = c(1000, 500, 2000, 1500, 3000))

out4 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'early'))

out5 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'late'))

out6 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'mid'))

```

```{r}
plot(out4$time, out4$slurry_mass, type = 'l', ylim = c(0, 3500))
lines(out5$time, out5$slurry_mass, type = 'l', col = 'blue')
lines(out6$time, out6$slurry_mass, type = 'l', col = 'orange')
points(slurry_mass_dat$time, slurry_mass_dat$slurry_mass, col = 'red', pch = 19)
```

# Case 3, slurry removal at end

```{r}
slurry_mass_dat <- data.frame(time = c(0, 1, 10, 15, 30), 
                              slurry_mass = c(1000, 2000, 4000, 4500, 1000))

out7 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'early'))

out8 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'late'))

out9 <- abm(30, delta_t = 0.1, add_pars = list(storage_depth = 4, area = 1000, 
                                               slurry_mass = slurry_mass_dat, 
                                               approx_method.slurry_mass = 'mid'))


```

```{r}
plot(out7$time, out7$slurry_mass, type = 'l', ylim = c(0, 5500))
lines(out8$time, out8$slurry_mass, type = 'l', col = 'blue')
lines(out9$time, out9$slurry_mass, type = 'l', col = 'orange')
points(slurry_mass_dat$time, slurry_mass_dat$slurry_mass, col = 'red', pch = 19)
```

Note that last input point is ignored for 'late' method.

```{r}
plot(out7$time, out7$CH4_emis_rate, type = 'l')
lines(out8$time, out8$CH4_emis_rate, type = 'l', col = 'blue')
lines(out9$time, out9$CH4_emis_rate, type = 'l', col = 'orange')
```


