---
title: 'Demonstrations'
output: pdf_document
author: Sasha D. Hafner
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

# Introduction
This document presents an application of an extended version of ABM to transformation of dairy wastewater organic matter in a lagoon.
It is a mix of descriptive text, R code, and model output.

```{r, echo = FALSE}
rm(list = ls())
ff <- list.files('../R', full.names = TRUE)
for (i in ff) source(i)
```

# Set inputs
The "fresh" concentrations in the model define the lagoon influent, which is added at a fixed, constant rate.
These values are roughly from the "MEB" values.

```{r}
conc_fresh <- list(S2 = 0, SO4 = 0, TAN = 1.0, 
                   TS = 30, TSS = 20, 
                   VS = 20, VSS = 15, 
                   dsVS = 0, dVSS = 10)
```

Here, the lowercase prefixes `d` and `s` mean "degradable" and "soluble" (dissolved). 
The other influent ("manure") inputs are density and pH. 

```{r}
man_pars <- list(conc_fresh = conc_fresh, pH = 7, dens = 1000)
```

We'll use a flow rate of 3 million L/d (about 0.8 million gal/d), and assume that half of that is from wash water recyle.
This gives a net flow rate of 2 million L/d, and if we assume a storage capacity of 100 d, we need a lagoon volume of 0.2 million m$^3$.
With a 3 m depth, the surface (and floor) area will be about 70,000 m$^2$, but we'll use 100,000 for a safety factor.

```{r}
mng_pars <- list(slurry_prod_rate = 2E6, slurry_rem_rate = 1E6, 
                 slurry_mass = 100E6, 
                 storage_depth = 3, area = 1E5, resid_depth = 1,
                 empty_int = 100)
```

The `prod`uction and `rem`oval rates are applied as constant values--so there is always influent going in and effluent (recycled water) going out.
(ABM can handle variable flows, but I have assumed this isn't needed.)
In addition, the lagoon is emptied down to some residual depth (1 m here) every 100 days.
ABM can handle variable flows in and out.

Lastly, we need to provide temperature data.
ABM accepts any resolution of temperature data.
Without measurements, we could use weather data and a heat transfer model called STM (here: <https://github.com/sashahafner/STM>).
For now, we'll use average air temperature by month. 

```{r}
temp <- read.csv('temp.csv')
plot(temp_C ~ time, data = temp, type = 'o')
```

Let's add these data.

```{r}
mng_pars[['temp_C']] <- temp
```

# Run model

We can now run the model with:

```{r}
tso <- abm(365, 1, man_pars = man_pars, add_pars = mng_pars)
```

# Outpt

Temperature and slurry mass in lagoon.

```{r}
plot(temp_C ~ time, data = tso, type = 'l', xlab = 'Day of year', ylab = expression('Temperature'~(degree*C)))
plot(slurry_mass/1E6 ~ time, data = tso, type = 'l', xlab = 'Day of year', ylab = 'Lagoon quantity (1000 t)', ylim = c(0, max(tso$slurry_mass/1E6)))
```

Effluent composition.
First TS and VS.

```{r}
plot(TS_conc ~ time, data = tso, type = 'l', ylim = c(0, man_pars$conc_fresh$TS), xlab = 'Day of year', ylab = 'Concentration (g/kg)')
lines(VS_conc ~ time, data = tso, type = 'l', col = 'red')
lines(VSS_conc ~ time, data = tso, type = 'l', col = 'blue')
```

COD fractions, some measureable, some not.

```{r}
plot(COD_conc ~ time, data = tso, type = 'l', ylim = c(0, max(tso$COD_conc)), xlab = 'Day of year', ylab = 'Concentration (g/kg)')
lines(dpCOD_conc ~ time, data = tso, type = 'l', col = 'red')
lines(dsCOD_conc ~ time, data = tso, type = 'l', col = 'blue')
```

Microbial community.

```{r}
matplot(tso$time, tso[, nn <- c('m1', 'm2', 'm3')] / max(tso[, nn <- c('m1', 'm2', 'm3')]),
  type = 'l', lty = 1, ylim = c(0, 1), xlab = 'Time (d)', ylab = 'Microbial biomass (relative)')
legend('topleft', nn, col = 1:6, lty = 1)
```
