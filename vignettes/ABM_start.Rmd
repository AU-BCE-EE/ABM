---
title: "Getting Started with the ABM Package in R"
author: "Frederik R. Dalby and Sasha D. Hafner"
date: "`r Sys.Date()`"
fig_width: 6 
fig_height: 4 
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ABM_start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r,echo=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=4)
options(width = 85)
```

# 1. Overview
The ABM model predicts conversion of organic material in animal manure or other (high-moisture) organic wastes to methane (CH~4~), carbon dioxide (CO~2~) and ammonia (NH~3~) under anaerobic conditions.
The name comes from **a**naerobic **b**iodegradation **m**odel.
With multiple methanogen groups and a single sulfate reducer group and group-specific parameters describing kinetics and yield, the model can predict realistic short- and long-term responses to temperature change and other perturbations.
Although it was prediction of CH~4~ emission from stored animal slurry (liquid manure) in unheated channels or tanks that prompted development of the model, the model can be used to simulate CH~4~ emission or biogas production from other organic waste under a range of conditions, including in anaerobic digesters.
The purpose of this document is to demonstrate the use of the ABM R package, which is a flexible implementation of the model.
Details on the model will be available in publications in the near future.

# 2. Installation
The ABM package is available on GitHub and so can be installed with the `install_github()` function from the devtools package, which must be installed first.
These steps should be carried out once to install both packages:

```{r, eval=FALSE}
install.packages('devtools')
devtools::install_github('AU-BCE-EE/ABM', build_vignettes = TRUE)
```

And to use the ABM model, the package must be loaded.

```{r,eval= TRUE}
library(ABM)
```

And to view this vignette, use:

```{r}
vignette('ABM_start')
```

# 3. A demonstration of pig farm emissions
A demonstration is presented in this section to show what the abm() function can do.
For a more incremental introduction to the function, see the following sections.

First we will start with a demonstration using the default input parameters, which reflect manure production in a pig-house with 1000 finisher growing pigs. In-house slurry pits are 0.6 m deep and the slurry is flushed out of the pig-house every 28 days, leaving 5 cm of residual slurry inside the in-house slurry pits. The slurry temperature is 20&degC. The amount of degradable VS content of raw pig manure is set to 75 gCOD/kg manure (feces + urine). 

To predict in-house manure methane emission we can make the following call, specifying that we want to run the model for 365 days 

```{r}
out0 <- abm(days = 365) # run the simulation for 365 days
```
Â¨
Lets take a look at the output of microbial groups methanogens m0, m1, m2 and sulfate reducer group sr1.
```{r}
line_colors <- c('red', 'blue', 'green','orange')
matplot(out0$time, out0[, nn <- c('m0','m1','m2','sr1')]/1000, 
        type = 'l', lty = c(1:length(nn)), col = line_colors, xlab = 'Time (d)', ylab = 'Microbial biomass (kg)')
legend("topright", legend = nn, lty = c(1:length(nn)), col = line_colors, lwd = 1,
       title = "Microbial biomass", cex = 0.8)

matplot(out0$time, out0[, nn <- c('CH4_emis_rate', 'CO2_emis_rate', 'NH3_emis_rate')]/1000, 
        type = 'l', lty = c(1:length(nn)), col = line_colors, xlab = 'Time (d)', ylab = 'Emission rate (kg/day)')
legend("topright", legend = nn, lty = c(1:length(nn)), col = line_colors, lwd = 1,
       title = "Emission rates", cex = 0.8)

```
Methane and carbon dioxide emission rates follow a clear pattern correlated with the amount of slurry in the slurry pits, which is flushed out every 28 days. 

So how much methane per pig per year from the in-house emission?
We can use the cumulative methane output and the fact that slurry production rate default is for 1000 pigs.
For ammonia we might want to have emissions per production area. Since we assume that the floor is fully slatted, we can assume that the production area of the pigs are equal to the slurry surface area 

```{r}
pigs <- 1000
CH4_kg_pr_pig_pr_year <- max(out0$CH4_emis_cum)/1000/pigs 
CH4_kg_pr_pig_pr_year
CO2_kg_pr_pig_pr_year <- max(out0$CO2_emis_cum)/1000/pigs 
CO2_kg_pr_pig_pr_year
NH3_kg_pr_pig_pr_year <- max(out0$NH3_emis_cum)/1000/out0$area[1]
NH3_kg_pr_pig_pr_year
C_ratio <- (CH4_kg_pr_pig_pr_year * 12/16) / (CO2_kg_pr_pig_pr_year * 12/44 + CH4_kg_pr_pig_pr_year * 12/16)
C_ratio
```
Only ~26% of carbon emission is methane, suggesting that a lot of carbon dioxide comes from non-methanogenic processes (urea hydrolysis and surface respiration).  

We can continue our calculations by doing another simulation of emissions coming from the outside slurry tank, by using the effluents from the in-house simulation as input for our storage simulation. 
To do this we extract the effluent slurry masses and pass to the new simulation as a data.frame using the add_pars argument. With add_pars we can change the default input parameters. In the outside storage, the temperature will also changes considerably over the year, so temperature will also be passed as a data.frame(). We will get our temperature data another file. Since Some VS was degraded in the barn we have to change the VS in the manure going to the outside storage also.

```{r}
# fix this. 
out0 <- out0[!duplicated(out0$time), ]
slurry_mass_intp <- approx(out0$time, out0$slurry_mass_eff, xout = out0$time)$y
slurry_mass_cum <- cumsum(slurry_mass_intp)
slurry_mass_dat <- data.frame(time = out0$time, slurry_mass = slurry_mass_cum)
slurry_mass_dat
VSd_fresh <- mean(out0$VSd_eff_conc, na.rm = T)
VSd_fresh
temp_dat <- read.csv('../dat/outside_slurry_temp.csv', sep = ';')
temp_dat

```

Lets look at temperature and slurry data before we continue

```{r}
plot(slurry_mass_dat$time, slurry_mass_dat$slurry_mass, ylab = 'Slurry_mass (kg)', 
     xlab = 'Time (days from 1. Apr)')
plot(temp_dat$time, temp_dat$temp_C, ylab = 'Temperature (deg C)', xlab = 'Time (days from 1. Apr)')
```
We need to adjust dimensions of outside slury storage, height = 4 m, surface area = 1000
```{r}

out1 <- abm(365, add_pars = list(storage_depth = 4, area = 1000, floor_area = 0, slurry_mass = slurry_mass_dat, temp_C = temp_dat, conc_fresh.VSd = VSd_fresh, conc_fresh.urea = 0))

```

Clearly emissions peak during the summer period, due to higher methanogenesis activity. 

```{r}
plot(CH4_emis_rate ~ time, data = out1, type = 'l', xlab = 'Time (d)', ylab = 'CH4 emission rate (g/d)')
plot(CH4_emis_cum ~ time, data = out1, type = 'l', xlab = 'Time (d)', ylab = 'CH4 cumulative emission (g)')
```
We can even look at the VFA dynamics durign the year

```{r}
plot(VFA_conc ~ time, data = out1, type = 'l', xlab = 'Time (d)', ylab = 'VFA conc. (g/kg)')
```

Because we would ideally like a stabilization period, we can run the model for three years and take a look only at the last year by using the `startup` argument. Furthermore, we can also focus on total emission in the last year (`value = "summ"`).

```{r}
out1a <- abm(3*365, add_pars = list(storage_depth = 4, area = 1000, floor_area = 0, slurry_mass = slurry_mass_dat, temp_C = temp_dat, conc_fresh.VSd = VSd_fresh, conc_fresh.urea = 0), startup = 2, value = 'summ')
out1a
```

Results show total annual emission from the outside storage of about 5.5 kg CH~4 per pig (CH4_emis_cum/1000 pigs / 1000 g pr kg)

How much might acidification reduce emission?
We can easily make a comparison to a scenario with pH reduced to 6, with everything else the same.pH is indirectly affecting methane because reduced pH increase concentration of toxic H2S, and protonated VFAs.


```{r}
out1b <- abm(3*365, add_pars = list(storage_depth = 4, area = 1000, floor_area = 0, slurry_mass = slurry_mass_dat, temp_C = temp_dat, conc_fresh.VSd = VSd_fresh, conc_fresh.urea = 0, pH = 5.5), startup = 2, value = 'summ')
out1b
```

The predicted reduction is 95.1%.

```{r}
1 - out1b['CH4_emis_cum'] / out1a['CH4_emis_cum']
```
# 4. Setting parameter values
Although the ABM model is relatively simple, explicitly simulating the activity of multiple microbial groups means there are many parameters. 
The complete list and definitions can be seen in the help file, accessible with the following command.

```{r,eval=FALSE}
?abm
```

Alternatively, use `args()` just to see the arguments and default values.

```{r}
args(abm)
```

Parameters are grouped to make changes easier (and to prevent input mistakes) and to limit the number of parameter names that are needed.
The `mng_pars` argument contains parameters related to management; `man_pars` describes the incoming manure or feed; `grp_pars`, the most extensive argument, is used to define the microbial groups; `mic_pars` contains other microbial parameters that do not vary among groups; `chem_pars` sets some chemical/physical parameters; `arrh_pars` sets kinetic parameters controlling hydrolysis rates of different organic matter components. The `arrh_pars` is used when instead of specifying substrate input as degradable volatile solids, we can specify: 
crude protein (CP), crude fats (CF), residual degradable fiber (RFd), starch and sugars (starch), and even more componenets. In that case VSd should be set to 0. `init_pars` are the initial concentrations of organic matter componenets in the storage, which by default is equal to the concentration i the excreted manure, but it can be changed here.  

There are also some built-in shortcuts to make small tweaks simple.
In particular, the `add_pars` argument makes life easy, and was used in the first demonstration.

As an example, the composition of the fresh slurry (influent, or feed) is set with the `man_pars` argument, which is a list of solute concentrations and pH.
An example with CP, CF, RFd specified rather than VSd is given below and with a simple change in VFA_concentration using the add_pars argument. 


```{r}
man_pars = list(conc_fresh = list(sulfide = 0.01, urea = 2.4, sulfate = 0.2, TAN = 0.0, starch = 1, 
                                    VFA = 2.83, xa_dead = 0, CF = 12, CP = 20, RFd = 29, iNDF = 10, VSd = 0, 
                                    VSd_A = 44.4, VSnd_A = 20, ash = 15), pH = 7, dens = 1000)

out2a <- abm(365, man_pars = man_pars)
out2b <- abm(365, man_pars = man_pars, add_pars = list(conc_fresh.VFA = 10))

plot(VFA_conc ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'VFA conc. (g/kg)', ylim = c(0,10))
lines(out2b$time, out2b$VFA_conc, col = "red")
```
If the we use the add_pars to change a variable that is not within a sublist like VFA in "conc_fresh", we can simply type the variable directly without punctuation.  

```{r}

out2c <- abm(365, man_pars = man_pars, add_pars = list(slurry_prod_rate = 10000))

plot(CH4_emis_rate ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'CH4 emis rate (g/day)', ylim = c(0,20000))
lines(out2c$time, out2c$CH4_emis_rate, col = "red")
```
We can also change any OM concentrations in the excreted manure over time by passing it as a conc_fresh as a data.frame. Below example with changed VFA (which increase methane production), sulfide concentrations (which inhibit methanogens) and total ammonia nitrogen (TAN).

```{r}

man_pars = list(conc_fresh = data.frame(time = c(0, 100, 101, 365), sulfide = c(0.01, 0.01, 0.1, 0.1), urea = 0, 
                                        sulfate = 0.2, TAN = c(0, 3, 5, 6), starch = 1, 
                                        VFA = c(2.83, 2.83, 10, 10), 
                                        xa_dead = 0, CF = 12, CP = 20, RFd = 29, iNDF = 10, VSd = 0, 
                                        VSd_A = 44.4, VSnd_A = 20, ash = 15), pH = 7, dens = 1000)

out2d <- abm(365, man_pars = man_pars)

plot(CH4_emis_rate ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'CH4 emis rate (g/day)', ylim = c(0,20000))
lines(out2d$time, out2d$CH4_emis_rate, col = "red")

plot(VFA_conc ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'VFA conc. (g/kg)', ylim = c(0,12))
lines(out2d$time, out2d$VFA_conc, col = "red")

plot(H2S_inhib_m0 ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'inhibition', ylim = c(0,1))
lines(out2d$time, out2d$H2S_inhib_m0, col = "red")
lines(out2d$time, out2d$cum_inhib_m0, col = "red", lty = 2)

```
The H2S inhibition constant is plotted for the methanogen "m0", as by default inhibition kinetics are similar for all groups of methanogens. Due to the TAN added, the cumulative inhibition constant is even lower than just inhibition from H2S.  

A similar change in the concentration of microbial populations in the fresh manure can be simulated:

```{r}
xa_fresh <- data.frame(time = c(0, 100, 101, 365), m0 = c(2, 0.0628, 0.0628, 0.0628), m1 = c(0.0628, 1, 2, 0.01), m2 = c(0.0628, 0.01, 0.01, 0.1), sr1 = c(0.0628, 1, 2, 0.01))

out2e <- abm(365, man_pars = man_pars, add_pars = list(xa_fresh = xa_fresh))

plot(CH4_emis_rate ~ time, data = out2a, type = 'l', xlab = 'Time (d)', ylab = 'CH4 emis rate (g/day)', ylim = c(0,10))
lines(out2e$time, out2e$CH4_emis_rate, col = "red")

matplot(out2e$time, out2e[, nn <- c('m0_conc','m1_conc','m2_conc','sr1_conc')]/1000, 
        type = 'l', lty = c(1:length(nn)), col = line_colors, xlab = 'Time (d)', ylab = 'Microbial biomass (gCOD/kg)')
legend("topright", legend = nn, lty = c(1:length(nn)), col = line_colors, lwd = 1,
       title = "Microbial biomass", cex = 0.8)
```

